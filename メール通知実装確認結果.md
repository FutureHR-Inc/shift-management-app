# ãƒ¡ãƒ¼ãƒ«é€šçŸ¥å®Ÿè£…ç¢ºèªçµæœ

## ç¢ºèªæ—¥
2024å¹´12æœˆï¼ˆç¢ºèªæ™‚ç‚¹ï¼‰

## å®Ÿè£…çŠ¶æ³ã‚µãƒãƒªãƒ¼

### âœ… å®Ÿè£…æ¸ˆã¿
- åº—é•·å‘ã‘é€šçŸ¥ï¼š4é …ç›®ä¸­4é …ç›®
- ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘é€šçŸ¥ï¼š6é …ç›®ä¸­5é …ç›®

### âš ï¸ è¦ç¢ºèªãƒ»ä¿®æ­£
- ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘é€šçŸ¥ï¼š1é …ç›®ï¼ˆä»£æ‰“ä¸æ¡ç”¨é€šçŸ¥ï¼‰

---

## åº—é•·ã¸ã®é€šçŸ¥

### 1. âœ… ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºæ™‚
**å®Ÿè£…å ´æ‰€**: `app/api/shift-requests/route.ts` (POST, 382-409è¡Œç›®)
**é–¢æ•°**: `sendManagerShiftRequestNotificationEmail`
**ç¢ºèª**: âœ… ã‚¹ã‚¿ãƒƒãƒ•ãŒã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’æå‡ºã—ãŸéš›ã«åº—é•·ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```335:409:app/api/shift-requests/route.ts
    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†
    try {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      const { data: userData } = await supabase
        .from('users')
        .select('name, email')
        .eq('id', user_id)
        .single();

      // åº—èˆ—ã®ç®¡ç†è€…æƒ…å ±ã‚’å–å¾—
      const { data: storeData } = await supabase
        .from('stores')
        .select(`
          id,
          name,
          users!store_managers(
            id,
            name,
            email
          )
        `)
        .eq('id', store_id)
        .single();

      // ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
      if (userData?.email) {
        const staffEmailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'shift-request-confirmation',
            userEmail: userData.email,
            userName: userData.name || 'ä¸æ˜',
            submissionPeriod: submission_period,
            submittedRequestsCount: data.length
          }),
        });

        if (!staffEmailResponse.ok) {
          console.warn('ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€æå‡ºã¯å®Œäº†ã—ã¾ã—ãŸ');
        } else {
          console.log('ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
        }
      }

      // åº—é•·ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
      if (storeData?.users) {
        const managers = storeData.users;
        for (const manager of managers) {
          if (manager.email) {
            const managerEmailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type: 'manager-shift-request-notification',
                userEmail: manager.email,
                userName: manager.name || 'ä¸æ˜',
                staffName: userData?.name || 'ä¸æ˜',
                submissionPeriod: submission_period,
                submittedRequestsCount: data.length
              }),
            });

            if (!managerEmailResponse.ok) {
              console.warn('åº—é•·ã¸ã®ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } else {
              console.log('åº—é•·ã¸ã®ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºé€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
            }
          }
        }
      }
    } catch (emailError) {
      console.error('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
      // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã§ã‚‚æå‡ºã¯æˆåŠŸã¨ã™ã‚‹
    }
```

### 2. âœ… ã‚·ãƒ•ãƒˆç¢ºå®š
**å®Ÿè£…å ´æ‰€**: `app/api/shifts/route.ts` (PATCH, 550-606è¡Œç›®)
**é–¢æ•°**: `sendManagerShiftConfirmationEmail`
**ç¢ºèª**: âœ… ã‚·ãƒ•ãƒˆç¢ºå®šæ™‚ã«åº—é•·ã¸ã‚‚é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```550:606:app/api/shifts/route.ts
        // åº—é•·ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        try {
          // åº—èˆ—ã®ç®¡ç†è€…æƒ…å ±ã‚’å–å¾—
          const { data: storeData } = await supabase
            .from('stores')
            .select(`
              id,
              name,
              users!store_managers(
                id,
                name,
                email
              )
            `)
            .eq('id', store_id)
            .single();

          if (storeData?.users) {
            const managers = storeData.users;
            for (const manager of managers) {
              if (manager.email) {
                try {
                  const managerEmailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                      type: 'manager-shift-confirmation',
                      userEmail: manager.email,
                      userName: manager.name || 'ä¸æ˜',
                      details: {
                        storeName: storeData.name || 'ä¸æ˜ãªåº—èˆ—',
                        period: `${weekStartStr} ï½ ${weekEndStr}`,
                        confirmedShiftsCount: updatedShifts.length
                      }
                    }),
                  });

                  if (!managerEmailResponse.ok) {
                    const errorText = await managerEmailResponse.text();
                    throw new Error(`åº—é•·ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—: ${errorText}`);
                  }

                  const responseData = await managerEmailResponse.json();
                  console.log(`âœ… åº—é•·ã¸ã®ã‚·ãƒ•ãƒˆç¢ºå®šé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: ${manager.email}`, responseData);
                } catch (error) {
                  console.error(`âŒ åº—é•·ã¸ã®ã‚·ãƒ•ãƒˆç¢ºå®šé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${manager.email}`, error);
                  throw error;
                }
              }
            }
          }
        } catch (managerEmailError) {
          console.error('åº—é•·ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', managerEmailError);
          // åº—é•·ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã§ã‚‚ã‚·ãƒ•ãƒˆç¢ºå®šã¯æˆåŠŸã¨ã™ã‚‹
        }
```

### 3. âœ… ä»£æ‰“å¿œå‹Ÿæ™‚
**å®Ÿè£…å ´æ‰€**: `app/api/emergency-volunteers/route.ts` (POST, 251-285è¡Œç›®)
**é–¢æ•°**: `sendManagerEmergencyVolunteerNotificationEmail`
**ç¢ºèª**: âœ… ã‚¹ã‚¿ãƒƒãƒ•ãŒä»£æ‰“å‹Ÿé›†ã«å¿œå‹Ÿã—ãŸéš›ã«åº—é•·ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```251:285:app/api/emergency-volunteers/route.ts
      // åº—é•·ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
      if (storeData?.users && requestData && volunteerData) {
        const managers = storeData.users;
        for (const manager of managers) {
          if (manager.email) {
            const managerEmailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type: 'manager-emergency-volunteer-notification',
                userEmail: manager.email,
                userName: manager.name || 'ä¸æ˜',
                details: {
                  volunteerName: volunteerData.name || 'ä¸æ˜',
                  storeName: requestData.stores?.name || 'ä¸æ˜',
                  date: requestData.date,
                  timeSlot: requestData.time_slots?.name || 'ä¸æ˜',
                  startTime: requestData.time_slots?.start_time || '00:00',
                  endTime: requestData.time_slots?.end_time || '00:00',
                  originalStaffName: requestData.original_user?.name || 'ä¸æ˜',
                  notes: notes || undefined
                }
              }),
            });

            if (!managerEmailResponse.ok) {
              console.warn('åº—é•·ã¸ã®ä»£æ‰“å¿œå‹Ÿé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } else {
              console.log('åº—é•·ã¸ã®ä»£æ‰“å¿œå‹Ÿé€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
            }
          }
        }
      }
```

### 4. âœ… ä»£æ‰“æ±ºå®šæ™‚
**å®Ÿè£…å ´æ‰€**: `app/api/emergency-requests/route.ts` (PATCH, 679-744è¡Œç›®)
**é–¢æ•°**: `sendManagerSubstituteConfirmationEmail`
**ç¢ºèª**: âœ… ä»£æ‰“ã‚’æ‰¿èªã—ãŸéš›ã«åº—é•·ã¸ã‚‚é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```679:744:app/api/emergency-requests/route.ts
      // åº—é•·ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
      try {
        // åº—èˆ—ã®ç®¡ç†è€…æƒ…å ±ã‚’å–å¾—
        const { data: storeData } = await supabase
          .from('stores')
          .select(`
            id,
            name,
            users!store_managers(
              id,
              name,
              email
            )
          `)
          .eq('id', emergencyRequest.store_id)
          .single();

        // å¿œå‹Ÿè€…ã®æƒ…å ±ã‚’å–å¾—
        const { data: volunteerUser } = await supabase
          .from('users')
          .select('name')
          .eq('id', volunteer.user_id)
          .single();

        // å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•ã®æƒ…å ±ã‚’å–å¾—
        const { data: originalUser } = await supabase
          .from('users')
          .select('name')
          .eq('id', emergencyRequest.original_user_id)
          .single();

        if (storeData?.users) {
          const managers = storeData.users;
          for (const manager of managers) {
            if (manager.email) {
              const managerEmailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  type: 'manager-substitute-confirmation',
                  userEmail: manager.email,
                  userName: manager.name || 'ä¸æ˜',
                  details: {
                    storeName: storeData.name || 'ä¸æ˜ãªåº—èˆ—',
                    date: emergencyRequest.date,
                    timeSlot: emergencyRequest.time_slots?.name || 'ä¸æ˜',
                    originalStaffName: originalUser?.name || 'ä¸æ˜',
                    newStaffName: volunteerUser?.name || 'ä¸æ˜'
                  }
                }),
              });

              if (!managerEmailResponse.ok) {
                console.warn('åº—é•·ã¸ã®ä»£æ‰“ç¢ºå®šé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
              } else {
                console.log('åº—é•·ã¸ã®ä»£æ‰“ç¢ºå®šé€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
              }
            }
          }
        }
      } catch (managerEmailError) {
        console.error('åº—é•·ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', managerEmailError);
        // åº—é•·ã¸ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã§ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }
```

---

## ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®é€šçŸ¥

### 1. âœ… ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºãƒªãƒã‚¤ãƒ³ãƒ‰
**å®Ÿè£…å ´æ‰€**: `app/api/cron/shift-request-reminders/route.ts`
**é–¢æ•°**: `sendShiftRequestReminderEmail` (ãƒãƒƒãƒå‡¦ç†: `sendBatchShiftRequestReminders`)
**ç¢ºèª**: âœ… ç· åˆ‡3æ—¥å‰ã«æœªæå‡ºè€…ã¸ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
**å®Ÿè¡Œæ–¹æ³•**: Cron Jobï¼ˆVercel Cronè¨­å®šãŒå¿…è¦ï¼‰

```6:156:app/api/cron/shift-request-reminders/route.ts
export async function GET(request: NextRequest) {
  try {
    // Vercel Cron Jobã®èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    const authHeader = request.headers.get('authorization');
    if (process.env.CRON_SECRET && authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
      return NextResponse.json({ error: 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 401 });
    }

    console.log('Starting shift request reminder notifications...');

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆJSTï¼‰
    const today = new Date();
    const jstOffset = 9 * 60 * 60 * 1000; // JST = UTC + 9æ™‚é–“
    const jstToday = new Date(today.getTime() + jstOffset);

    // ç¾åœ¨ã®æå‡ºæœŸé–“ã‚’å–å¾—
    const currentPeriods = getSubmissionPeriods();
    let activeSubmissionPeriod = null;
    let deadline = null;

    // ä»Šæ—¥ãŒæå‡ºæœŸé–“å†…ã‹ãƒã‚§ãƒƒã‚¯
    for (const period of currentPeriods) {
      const deadlineDate = new Date(period.submissionDeadline);
      const reminderDate = new Date(deadlineDate.getTime() - 3 * 24 * 60 * 60 * 1000); // ç· åˆ‡3æ—¥å‰

      console.log('ğŸ” æœŸé–“ãƒã‚§ãƒƒã‚¯:', {
        period: period.label,
        deadline: period.submissionDeadline,
        reminderDate: reminderDate.toISOString(),
        today: jstToday.toISOString(),
        isInRange: jstToday >= reminderDate && jstToday <= deadlineDate
      });

      if (jstToday >= reminderDate && jstToday <= deadlineDate) {
        activeSubmissionPeriod = period.label;
        deadline = period.submissionDeadline;
        break;
      }
    }

    if (!activeSubmissionPeriod) {
      console.log('ç¾åœ¨ã¯ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡æœŸé–“ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
      return NextResponse.json({
        success: true,
        message: 'No active submission period for reminders',
        date: jstToday.toISOString().split('T')[0],
        processed: 0
      });
    }

    console.log(`ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡å¯¾è±¡æœŸé–“: ${activeSubmissionPeriod}, ç· åˆ‡: ${deadline}`);

    // å…¨ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—
    const { data: allStaff, error: staffError } = await supabase
      .from('users')
      .select('id, name, email, role')
      .eq('role', 'staff'); // ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿

    if (staffError) {
      console.error('Error fetching staff:', staffError);
      return NextResponse.json({ error: 'Failed to fetch staff' }, { status: 500 });
    }

    if (!allStaff || allStaff.length === 0) {
      console.log('ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      return NextResponse.json({
        success: true,
        message: 'No staff found',
        date: jstToday.toISOString().split('T')[0],
        processed: 0
      });
    }

    // æ—¢ã«æå‡ºæ¸ˆã¿ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—
    const { data: submittedRequests } = await supabase
      .from('shift_requests')
      .select('user_id')
      .eq('submission_period', activeSubmissionPeriod)
      .eq('status', 'submitted');

    const submittedUserIds = new Set(
      submittedRequests?.map(req => req.user_id) || []
    );

    // æœªæå‡ºã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç‰¹å®š
    const unsubmittedStaff = allStaff.filter(staff =>
      !submittedUserIds.has(staff.id) && staff.email
    );

    if (unsubmittedStaff.length === 0) {
      console.log('å…¨ã‚¹ã‚¿ãƒƒãƒ•ãŒæå‡ºæ¸ˆã¿ã§ã™');
      return NextResponse.json({
        success: true,
        message: 'All staff have submitted their requests',
        date: jstToday.toISOString().split('T')[0],
        processed: 0
      });
    }

    console.log(`${unsubmittedStaff.length}äººã®æœªæå‡ºã‚¹ã‚¿ãƒƒãƒ•ã«ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã™`);

    // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    console.log('ğŸ“§ æœªæå‡ºã‚¹ã‚¿ãƒƒãƒ•:', unsubmittedStaff.map(staff => ({
      id: staff.id,
      name: staff.name,
      email: staff.email
    })));

    const reminders = unsubmittedStaff.map(staff => ({
      userEmail: staff.email!,
      userName: staff.name || 'ä¸æ˜',
      submissionPeriod: activeSubmissionPeriod!,
      deadline: deadline!
    }));

    console.log('ğŸ“§ é€ä¿¡äºˆå®šã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼:', {
      count: reminders.length,
      period: activeSubmissionPeriod,
      deadline: deadline,
      reminders: reminders.map(r => ({
        email: r.userEmail,
        name: r.userName
      }))
    });

    // ãƒãƒƒãƒå‡¦ç†ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    const results = await sendBatchShiftRequestReminders(reminders);

    console.log('Shift request reminder notifications completed:', results);

    return NextResponse.json({
      success: true,
      message: 'Shift request reminder notifications processed',
      date: jstToday.toISOString().split('T')[0],
      stats: {
        totalStaff: allStaff.length,
        submittedStaff: submittedUserIds.size,
        unsubmittedStaff: unsubmittedStaff.length,
        remindersSent: results.success,
        emailResults: results
      }
    });

  } catch (error) {
    console.error('Shift request reminder notifications error:', error);
    return NextResponse.json({
      error: 'Internal server error',
      message: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
}
```

### 2. âœ… ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒå—ç†ã•ã‚ŒãŸ
**å®Ÿè£…å ´æ‰€**: `app/api/shift-requests/route.ts` (POST, 359-380è¡Œç›®)
**é–¢æ•°**: `sendShiftRequestConfirmationEmail`
**ç¢ºèª**: âœ… ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºå®Œäº†æ™‚ã«ã‚¹ã‚¿ãƒƒãƒ•ã¸ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```359:380:app/api/shift-requests/route.ts
      // ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
      if (userData?.email) {
        const staffEmailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'shift-request-confirmation',
            userEmail: userData.email,
            userName: userData.name || 'ä¸æ˜',
            submissionPeriod: submission_period,
            submittedRequestsCount: data.length
          }),
        });

        if (!staffEmailResponse.ok) {
          console.warn('ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€æå‡ºã¯å®Œäº†ã—ã¾ã—ãŸ');
        } else {
          console.log('ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
        }
      }
```

### 3. âœ… ã‚·ãƒ•ãƒˆç¢ºå®š
**å®Ÿè£…å ´æ‰€**: `app/api/shifts/route.ts` (PATCH, 464-548è¡Œç›®)
**é–¢æ•°**: `sendShiftConfirmationEmail`
**ç¢ºèª**: âœ… ã‚·ãƒ•ãƒˆç¢ºå®šæ™‚ã«ã‚¹ã‚¿ãƒƒãƒ•ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```464:548:app/api/shifts/route.ts
    // ã‚·ãƒ•ãƒˆç¢ºå®šæ™‚ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    if (status === 'confirmed' && updatedShifts && updatedShifts.length > 0) {
      try {
        console.log('ğŸ”„ ã‚·ãƒ•ãƒˆç¢ºå®šãƒ¡ãƒ¼ãƒ«é€ä¿¡é–‹å§‹:', {
          shiftCount: updatedShifts.length,
          shifts: updatedShifts.map(s => ({
            id: s.id,
            userId: s.user_id,
            userEmail: s.users?.email,
            userName: s.users?.name,
            date: s.date
          }))
        });

        // ã‚¹ã‚¿ãƒƒãƒ•ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const staffGroups = new Map();

        updatedShifts.forEach((shift: any) => {
          const userId = shift.user_id;
          if (!staffGroups.has(userId)) {
            staffGroups.set(userId, {
              user: shift.users,
              shifts: []
            });
          }
          staffGroups.get(userId).shifts.push(shift);
        });

        console.log('ğŸ“§ ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•æ•°:', staffGroups.size);

        // å„ã‚¹ã‚¿ãƒƒãƒ•ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        const emailPromises = Array.from(staffGroups.values()).map(async (group: any) => {
          if (!group.user?.email) {
            console.warn('âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', group.user);
            return;
          }

          console.log('ğŸ“¤ ãƒ¡ãƒ¼ãƒ«é€ä¿¡è©¦è¡Œ:', {
            email: group.user.email,
            name: group.user.name,
            shiftsCount: group.shifts.length,
            shifts: group.shifts.map((s: any) => ({
              date: s.date,
              timeSlot: s.time_slots?.name,
              store: s.stores?.name
            }))
          });

          try {
            const emailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type: 'shift-confirmation',
                userEmail: group.user.email,
                userName: group.user.name || 'ä¸æ˜',
                shifts: group.shifts.map((shift: any) => ({
                  date: shift.date,
                  storeName: shift.stores?.name || 'ä¸æ˜ãªåº—èˆ—',
                  shiftPattern: shift.time_slots?.name || 'ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“',
                  startTime: shift.custom_start_time || shift.time_slots?.start_time || '00:00',
                  endTime: shift.custom_end_time || shift.time_slots?.end_time || '00:00'
                }))
              }),
            });

            if (!emailResponse.ok) {
              const errorText = await emailResponse.text();
              throw new Error(`ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—: ${errorText}`);
            }

            const responseData = await emailResponse.json();
            console.log(`âœ… ã‚·ãƒ•ãƒˆç¢ºå®šãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: ${group.user.email}`, responseData);
          } catch (error) {
            console.error(`âŒ ã‚·ãƒ•ãƒˆç¢ºå®šãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${group.user.email}`, error);
            throw error;
          }

          // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ä¸Šã®try-catchãƒ–ãƒ­ãƒƒã‚¯ã§è¡Œã‚ã‚Œã¾ã™
        });

        await Promise.all(emailPromises);
        console.log('ğŸ‰ å…¨ã¦ã®ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ã‚·ãƒ•ãƒˆç¢ºå®šãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
```

### 4. âœ… ã‚·ãƒ•ãƒˆå¤‰æ›´ãŒã‚ã£ãŸã¨ã
**å®Ÿè£…å ´æ‰€**: `app/api/shifts/[id]/route.ts` (PUT/DELETE, 83-127è¡Œç›®, 172-211è¡Œç›®)
**é–¢æ•°**: `sendShiftChangeNotificationEmail`
**ç¢ºèª**: âœ… ã‚·ãƒ•ãƒˆã®æ›´æ–°ãƒ»å‰Šé™¤æ™‚ã«ã‚¹ã‚¿ãƒƒãƒ•ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```83:127:app/api/shifts/[id]/route.ts
    // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡
    try {
      const userEmail = updatedShift.users?.email;
      const userName = updatedShift.users?.name || 'ä¸æ˜';

      if (userEmail) {
        const emailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'shift-change',
            userEmail,
            userName,
            details: {
              date: updatedShift.date,
              storeName: updatedShift.stores?.name || 'ä¸æ˜ãªåº—èˆ—',
              oldTimeSlot: oldShift.time_slots?.name,
              newTimeSlot: updatedShift.time_slots?.name,
              oldTime: oldShift.time_slots ? {
                start: oldShift.custom_start_time || oldShift.time_slots.start_time,
                end: oldShift.custom_end_time || oldShift.time_slots.end_time
              } : undefined,
              newTime: updatedShift.time_slots ? {
                start: updatedShift.custom_start_time || updatedShift.time_slots.start_time,
                end: updatedShift.custom_end_time || updatedShift.time_slots.end_time
              } : undefined,
              type: changeType
            }
          }),
        });

        if (!emailResponse.ok) {
          const errorText = await emailResponse.text();
          throw new Error(`ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—: ${errorText}`);
        }

        const responseData = await emailResponse.json();
        console.log('âœ… ã‚·ãƒ•ãƒˆå¤‰æ›´ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ:', responseData);
      }
    } catch (emailError) {
      console.error('âŒ ã‚·ãƒ•ãƒˆå¤‰æ›´ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
      // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã¯ã‚·ãƒ•ãƒˆæ›´æ–°ã®æˆåŠŸã«å½±éŸ¿ã•ã›ãªã„
    }
```

### 5. âœ… ä»£æ‰“å‹Ÿé›†é–‹å§‹
**å®Ÿè£…å ´æ‰€**: `app/api/emergency-requests/route.ts` (POST, 289-340è¡Œç›®)
**é–¢æ•°**: `sendEmergencyShiftRequestEmail`
**ç¢ºèª**: âœ… ä»£æ‰“å‹Ÿé›†é–‹å§‹æ™‚ã«ã‚¹ã‚¿ãƒƒãƒ•ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
**æ³¨æ„**: ãƒ¡ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ãŒ `'emergency-shift-request'` ã ãŒã€`app/api/email/route.ts` ã§ã¯ `'emergency-request'` ã‚’æœŸå¾…ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼ˆè¦ç¢ºèªï¼‰

```289:340:app/api/emergency-requests/route.ts
    try {
      // åŒã˜åº—èˆ—ã®ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
      const { data: eligibleStaff } = await supabase
        .from('users')
        .select('id, name, email')
        .eq('role', 'staff')
        .eq('company_id', emergencyRequest.stores?.company_id)
        .neq('id', original_user_id); // å‹Ÿé›†ä½œæˆè€…ã‚’é™¤å¤–

      if (eligibleStaff && eligibleStaff.length > 0) {
        const staffEmails = eligibleStaff
          .filter(staff => staff.email) // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿
          .map(staff => staff.email);

        if (staffEmails.length > 0) {
          try {
            const emailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type: 'emergency-shift-request',
                userEmails: staffEmails,
                details: {
                  storeName: emergencyRequest.stores?.name || 'ä¸æ˜ãªåº—èˆ—',
                  date: emergencyRequest.date,
                  shiftPattern: emergencyRequest.time_slots?.name || 'ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“',
                  startTime: emergencyRequest.time_slots?.start_time || '00:00',
                  endTime: emergencyRequest.time_slots?.end_time || '00:00',
                  reason: emergencyRequest.reason,
                }
              }),
            });

            if (!emailResponse.ok) {
              const errorText = await emailResponse.text();
              throw new Error(`ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—: ${errorText}`);
            }

            const responseData = await emailResponse.json();
            console.log('âœ… ä»£æ‰“å‹Ÿé›†é–‹å§‹ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ:', responseData);
          } catch (emailError) {
            console.error('âŒ ä»£æ‰“å‹Ÿé›†é–‹å§‹ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
            // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã¯ç·Šæ€¥å‹Ÿé›†ä½œæˆã®æˆåŠŸã«å½±éŸ¿ã•ã›ãªã„
          }
        }
      }
    } catch (staffError) {
      console.error('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', staffError);
      // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±å–å¾—å¤±æ•—ã¯ç·Šæ€¥å‹Ÿé›†ä½œæˆã®æˆåŠŸã«å½±éŸ¿ã•ã›ãªã„
    }
```

### 6. âš ï¸ ä»£æ‰“æ±ºå®šï¼ˆæ¡ç”¨/ä¸æ¡ç”¨ï¼‰
**å®Ÿè£…çŠ¶æ³**: éƒ¨åˆ†çš„ã«å®Ÿè£…æ¸ˆã¿

#### 6-1. âœ… ä»£æ‰“æ¡ç”¨é€šçŸ¥
**å®Ÿè£…å ´æ‰€**: `app/api/emergency-requests/route.ts` (PATCH, 616-677è¡Œç›®)
**é–¢æ•°**: `sendSubstituteApprovedEmail`
**ç¢ºèª**: âœ… ä»£æ‰“ãŒæ¡ç”¨ã•ã‚ŒãŸéš›ã«å¿œå‹Ÿè€…ã¨å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

```616:677:app/api/emergency-requests/route.ts
      // å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•ã¨å¿œå‹Ÿè€…ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
      try {
        // å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•ã®æƒ…å ±ã‚’å–å¾—
        const { data: originalUser } = await supabase
          .from('users')
          .select('email, name')
          .eq('id', emergencyRequest.original_user_id)
          .single();

        // å¿œå‹Ÿè€…ã®æƒ…å ±ã‚’å–å¾—
        const { data: volunteerUser } = await supabase
          .from('users')
          .select('email, name')
          .eq('id', volunteer.user_id)
          .single();

        // åº—èˆ—æƒ…å ±ã‚’å–å¾—
        const { data: store } = await supabase
          .from('stores')
          .select('name')
          .eq('id', emergencyRequest.store_id)
          .single();

        if (originalUser?.email && volunteerUser?.email) {
          try {
            const emailResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type: 'substitute-approved',
                approvedUserEmail: volunteerUser.email,
                approvedUserName: volunteerUser.name || 'ä¸æ˜',
                originalUserEmail: originalUser.email,
                originalUserName: originalUser.name || 'ä¸æ˜',
                details: {
                  storeName: store?.name || 'ä¸æ˜ãªåº—èˆ—',
                  date: emergencyRequest.date,
                  timeSlot: emergencyRequest.time_slots?.name || 'ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“',
                  startTime: emergencyRequest.time_slots?.start_time || '00:00',
                  endTime: emergencyRequest.time_slots?.end_time || '00:00'
                }
              }),
            });

            if (!emailResponse.ok) {
              const errorText = await emailResponse.text();
              throw new Error(`ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—: ${errorText}`);
            }

            const responseData = await emailResponse.json();
            console.log('âœ… ä»£æ‰“æ±ºå®šãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ:', responseData);
          } catch (emailError) {
            console.error('âŒ ä»£æ‰“æ±ºå®šãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
            // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã¯ã‚·ãƒ•ãƒˆä½œæˆã«å½±éŸ¿ã•ã›ãªã„
          }
        }
      } catch (error) {
        console.error('ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã¯ã‚·ãƒ•ãƒˆä½œæˆã«å½±éŸ¿ã•ã›ãªã„
      }
```

#### 6-2. âŒ ä»£æ‰“ä¸æ¡ç”¨é€šçŸ¥
**å®Ÿè£…å ´æ‰€**: æœªå®Ÿè£…
**é–¢æ•°**: `sendSubstituteRejectedEmail` (é–¢æ•°ã¯å­˜åœ¨ã™ã‚‹ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„)
**ç¢ºèª**: âŒ ä»£æ‰“ãŒä¸æ¡ç”¨ï¼ˆrejectï¼‰ã•ã‚ŒãŸéš›ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„

**ç¾çŠ¶**: `app/api/emergency-requests/route.ts` ã®PATCHå‡¦ç†ã§ `action === 'reject'` ã®å ´åˆã€statusã®æ›´æ–°ã®ã¿è¡Œã‚ã‚Œã¦ãŠã‚Šã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ãŒãªã„ã€‚

```760:786:app/api/emergency-requests/route.ts
    // acceptã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€ã‚·ãƒ•ãƒˆä½œæˆæ™‚ã«æ—¢ã«statusã‚’æ›´æ–°ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯å´ä¸‹ã®å ´åˆã®ã¿æ›´æ–°
    if (action === 'reject') {
      console.log('âŒ å´ä¸‹å‡¦ç†ã€‚statusã‚’æ›´æ–°ã—ã¾ã™:', { volunteer_id: volunteer_id, status: 'rejected' });
      const { error: volunteerUpdateError } = await supabase
        .from('emergency_volunteers')
        .update({ status: 'rejected' })
        .eq('id', volunteer_id);

      if (volunteerUpdateError) {
        console.error('âŒ å¿œå‹Ÿè€…statusæ›´æ–°ã‚¨ãƒ©ãƒ¼ï¼ˆå´ä¸‹ï¼‰:', volunteerUpdateError);
        // statusã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è­¦å‘Šã®ã¿ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
        if (volunteerUpdateError.code === '42703' || volunteerUpdateError.message?.includes('column "status"')) {
          console.warn('âš ï¸ statusã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«statusã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
          // statusã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
        } else {
          return NextResponse.json(
            { error: 'å¿œå‹Ÿè€…ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', details: volunteerUpdateError.message },
            { status: 500, headers: corsHeaders }
          );
        }
      } else {
        console.log('âœ… statusæ›´æ–°æˆåŠŸï¼ˆå´ä¸‹ï¼‰');
      }
    } else {
      // acceptã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€ã‚·ãƒ•ãƒˆä½œæˆæ™‚ã«æ—¢ã«statusã‚’æ›´æ–°æ¸ˆã¿
      console.log('âœ… acceptã‚¢ã‚¯ã‚·ãƒ§ãƒ³: statusã¯æ—¢ã«æ›´æ–°æ¸ˆã¿ã§ã™');
    }
```

---

## è¦ä¿®æ­£ãƒ»æ”¹å–„ç‚¹

### 1. âš ï¸ ä»£æ‰“ä¸æ¡ç”¨é€šçŸ¥ã®å®Ÿè£…
**å•é¡Œ**: ä»£æ‰“ãŒä¸æ¡ç”¨ï¼ˆrejectï¼‰ã•ã‚ŒãŸéš›ã«ã‚¹ã‚¿ãƒƒãƒ•ã¸é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¦ã„ãªã„
**å¯¾å¿œ**: `app/api/emergency-requests/route.ts` ã®PATCHå‡¦ç†ã§ `action === 'reject'` ã®å ´åˆã« `sendSubstituteRejectedEmail` ã‚’å‘¼ã³å‡ºã™å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### 2. âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ã®ä¸ä¸€è‡´
**å•é¡Œ**: `app/api/emergency-requests/route.ts` ã§ `type: 'emergency-shift-request'` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŒã€`app/api/email/route.ts` ã§ã¯ `'emergency-request'` ã‚’æœŸå¾…ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
**ç¢ºèª**: `app/api/email/route.ts` ã®41è¡Œç›®ã‚’ç¢ºèªã—ã€æ­£ã—ã„ã‚¿ã‚¤ãƒ—åã‚’ä½¿ç”¨ã™ã‚‹

```41:44:app/api/email/route.ts
      case 'emergency-request':
        const { userEmails, details } = emailData;
        await sendEmergencyShiftRequestEmail(userEmails, details);
        break;
```

**å¯¾å¿œ**: `app/api/emergency-requests/route.ts` ã®311è¡Œç›®ã‚’ `'emergency-request'` ã«ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

---

## å®Ÿè£…æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«é–¢æ•°ä¸€è¦§

### åº—é•·å‘ã‘
- âœ… `sendManagerShiftRequestNotificationEmail` - ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºé€šçŸ¥
- âœ… `sendManagerShiftConfirmationEmail` - ã‚·ãƒ•ãƒˆç¢ºå®šå®Œäº†é€šçŸ¥
- âœ… `sendManagerEmergencyVolunteerNotificationEmail` - ä»£æ‰“å¿œå‹Ÿé€šçŸ¥
- âœ… `sendManagerSubstituteConfirmationEmail` - ä»£æ‰“ç¢ºå®šé€šçŸ¥

### ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘
- âœ… `sendShiftRequestConfirmationEmail` - ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºç¢ºèª
- âœ… `sendShiftRequestReminderEmail` - ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºãƒªãƒã‚¤ãƒ³ãƒ‰
- âœ… `sendShiftConfirmationEmail` - ã‚·ãƒ•ãƒˆç¢ºå®šé€šçŸ¥
- âœ… `sendShiftChangeNotificationEmail` - ã‚·ãƒ•ãƒˆå¤‰æ›´é€šçŸ¥
- âœ… `sendEmergencyShiftRequestEmail` - ä»£æ‰“å‹Ÿé›†é–‹å§‹é€šçŸ¥
- âœ… `sendSubstituteApprovedEmail` - ä»£æ‰“æ¡ç”¨é€šçŸ¥
- âŒ `sendSubstituteRejectedEmail` - ä»£æ‰“ä¸æ¡ç”¨é€šçŸ¥ï¼ˆé–¢æ•°ã¯å­˜åœ¨ã™ã‚‹ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ï¼‰

---

## ã¾ã¨ã‚

### å®Ÿè£…çŠ¶æ³
- **åº—é•·å‘ã‘é€šçŸ¥**: 4é …ç›®ã™ã¹ã¦å®Ÿè£…æ¸ˆã¿ âœ…
- **ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘é€šçŸ¥**: 6é …ç›®ä¸­5é …ç›®å®Ÿè£…æ¸ˆã¿ã€1é …ç›®æœªå®Ÿè£… âš ï¸

### å„ªå…ˆåº¦ã®é«˜ã„ä¿®æ­£
1. **ä»£æ‰“ä¸æ¡ç”¨é€šçŸ¥ã®å®Ÿè£…** - ã‚¹ã‚¿ãƒƒãƒ•ãŒä»£æ‰“å¿œå‹Ÿã—ãŸéš›ã«ä¸æ¡ç”¨ã«ãªã£ãŸå ´åˆã®é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¦ã„ãªã„
2. **ãƒ¡ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—åã®ç¢ºèª** - `emergency-shift-request` ã¨ `emergency-request` ã®ä¸ä¸€è‡´ã‚’ç¢ºèªãƒ»ä¿®æ­£

### ãã®ä»–ã®ç¢ºèªäº‹é …
- Cron Jobã®è¨­å®šçŠ¶æ³ï¼ˆã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ä¸€è²«æ€§
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®ãƒ­ã‚°å‡ºåŠ›ã®ç¢ºèª

