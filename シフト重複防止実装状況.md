# 異なる店舗間でのシフト重複防止 - 実装状況まとめ

## 重複が発生する可能性のあるケース

### 1. 通常シフト作成時の重複
- **ケース1-1**: 店長が手動でシフトを作成する際、同じスタッフが同日に異なる店舗でシフトを持つ
- **ケース1-2**: シフト希望からシフトに変換する際、同じスタッフが同日に異なる店舗でシフトを持つ
- **ケース1-3**: 代打応募を承認してシフトを作成する際、応募者が同日に異なる店舗でシフトを持つ

### 2. 固定シフト作成時の重複
- **ケース2-1**: 店長が固定シフトを作成する際、同じスタッフが同じ曜日・時間帯に異なる店舗で固定シフトを持つ
- **ケース2-2**: 通常シフトと固定シフトの組み合わせで、同じスタッフが同日に異なる店舗でシフトを持つ

### 3. シフト希望提出時の重複
- **ケース3-1**: スタッフがシフト希望を提出する際、既に異なる店舗で同日のシフト（通常シフト・固定シフト）がある

### 4. 代打応募時の重複
- **ケース4-1**: スタッフが代打募集に応募する際、既に同日に他のシフト（通常シフト・固定シフト）がある
- **ケース4-2**: 同じスタッフが同じ代打募集に複数回応募する

### 5. 代打応募承認時の重複
- **ケース5-1**: 店長が代打応募を承認してシフトを作成する際、応募者が同日に異なる店舗でシフトを持つ

---

## 実装状況の詳細

### ✅ 実装済み

#### 1. 通常シフト作成（`/api/shifts` POST）
**ファイル**: `app/api/shifts/route.ts` (174-238行目)

**実装内容**:
- ✅ **異なる店舗への通常シフト重複チェック**: 同じスタッフが同日に異なる店舗で通常シフトを持つことを防止
  ```typescript
  const { data: existingShifts } = await supabase
    .from('shifts')
    .select('id, store_id, stores(id, name)')
    .eq('user_id', user_id)
    .eq('date', date)
    .neq('store_id', store_id); // 異なる店舗
  ```
- ✅ **異なる店舗への固定シフト重複チェック**: 同じスタッフが同じ曜日・時間帯に異なる店舗で固定シフトを持つことを防止
  ```typescript
  const { data: existingFixedShifts } = await supabase
    .from('fixed_shifts')
    .select('id, store_id, stores(id, name)')
    .eq('user_id', user_id)
    .eq('day_of_week', dayOfWeek)
    .eq('time_slot_id', finalTimeSlotId)
    .eq('is_active', true)
    .neq('store_id', store_id); // 異なる店舗
  ```

**フロントエンド**: `app/shift/create/page.tsx` (925-935行目)
- ✅ `checkStaffShiftStatus`関数で異なる店舗への重複をチェック

#### 2. 固定シフト作成（`/api/fixed-shifts` POST）
**ファイル**: `app/api/fixed-shifts/route.ts` (106-135行目)

**実装内容**:
- ✅ **異なる店舗への固定シフト重複チェック**: 同じスタッフが同じ曜日・時間帯に異なる店舗で固定シフトを持つことを防止
  ```typescript
  const { data: otherStoreShifts } = await supabase
    .from('fixed_shifts')
    .select('id, store_id, stores(id, name)')
    .eq('user_id', user_id)
    .neq('store_id', store_id) // 異なる店舗
    .eq('day_of_week', day_of_week)
    .eq('time_slot_id', time_slot_id)
    .eq('is_active', true);
  ```

#### 3. 代打応募（`/api/emergency-volunteers` POST）
**ファイル**: `app/api/emergency-volunteers/route.ts` (69-139行目)

**実装内容**:
- ✅ **重複応募の防止**: 同じスタッフが同じ代打募集に複数回応募することを防止
  ```typescript
  const { data: existingVolunteer } = await supabase
    .from('emergency_volunteers')
    .select('id')
    .eq('emergency_request_id', emergency_request_id)
    .eq('user_id', user_id)
    .single();
  ```
- ✅ **同日のシフト重複チェック**: 応募者が同じ日に他のシフト（店舗問わず）を持っている場合、応募を拒否
  ```typescript
  const { data: existingShifts } = await supabase
    .from('shifts')
    .select('id, store_id, status, stores(id, name)')
    .eq('user_id', user_id)
    .eq('date', emergencyRequest.date);
  ```
  **注意**: このチェックは`shifts`テーブルのみを確認しており、`fixed_shifts`テーブルは確認していない可能性がある

---

### ❌ 未実装・不完全

#### 1. シフト希望提出（`/api/shift-requests` POST）
**ファイル**: `app/api/shift-requests/route.ts` (114-337行目)

**現状**:
- ❌ **異なる店舗への重複チェック未実装**: スタッフがシフト希望を提出する際、既に異なる店舗で同日のシフト（通常シフト・固定シフト）があるかチェックしていない
- ✅ 同じ店舗・同じ日付での重複は防止されている（フロントエンドで`isDateSubmitted`、`hasFixedShift`、`hasConfirmedShift`でチェック）

**問題点**:
- スタッフが異なる店舗で同日のシフト希望を提出できてしまう
- 店長が承認する際に重複が発覚するが、その時点では既にシフト希望が提出済み

#### 2. シフト希望変換（`/api/shift-requests/convert` POST）
**ファイル**: `app/api/shift-requests/convert/route.ts` (79-97行目)

**現状**:
- ❌ **異なる店舗への重複チェック未実装**: シフト希望をシフトに変換する際、同じ店舗・同じ日付での重複のみチェック
  ```typescript
  const { data: existingShifts } = await supabase
    .from('shifts')
    .select('id')
    .eq('user_id', request.user_id)
    .eq('store_id', request.store_id)  // 同じ店舗のみチェック
    .eq('date', request.date);
  ```

**問題点**:
- 異なる店舗で同日のシフト希望が変換されると、重複シフトが作成される可能性がある

#### 3. 代打応募承認（`/api/emergency-requests` PATCH）
**ファイル**: `app/api/emergency-requests/route.ts` (409-434行目)

**現状**:
- ⚠️ **部分的に実装**: 既にシフトが存在する場合はチェックしているが、異なる店舗への重複チェックは未実装
  ```typescript
  // 既にシフトが作成されているか確認（重複防止）
  const { data: existingShift } = await supabase
    .from('shifts')
    .select('id')
    .eq('user_id', volunteer.user_id)
    .eq('date', emergencyRequest.date)
    .eq('store_id', emergencyRequest.store_id)  // 同じ店舗のみチェック
    .limit(1);
  ```

**問題点**:
- 応募者が異なる店舗で同日のシフトを持っている場合でも、代打応募を承認してシフトを作成できてしまう

#### 4. 代打応募時の固定シフトチェック
**ファイル**: `app/api/emergency-volunteers/route.ts` (104-139行目)

**現状**:
- ⚠️ **不完全**: 同日の通常シフト（`shifts`テーブル）のみチェックしており、固定シフト（`fixed_shifts`テーブル）はチェックしていない

**問題点**:
- 応募者が固定シフトで同日に他の店舗でシフトを持っている場合でも、代打応募できてしまう

---

## 推奨される修正

### 優先度: 高

1. **シフト希望提出時の異なる店舗重複チェック**
   - `app/api/shift-requests/route.ts`のPOST処理に、異なる店舗での通常シフト・固定シフトの重複チェックを追加

2. **シフト希望変換時の異なる店舗重複チェック**
   - `app/api/shift-requests/convert/route.ts`のPOST処理に、異なる店舗での通常シフト・固定シフトの重複チェックを追加

3. **代打応募承認時の異なる店舗重複チェック**
   - `app/api/emergency-requests/route.ts`のPATCH処理（acceptアクション）に、異なる店舗での通常シフト・固定シフトの重複チェックを追加

### 優先度: 中

4. **代打応募時の固定シフトチェック**
   - `app/api/emergency-volunteers/route.ts`のPOST処理に、固定シフトの重複チェックを追加

---

## 実装パターン（参考）

既に実装されている`/api/shifts` POSTのパターンを他のエンドポイントにも適用：

```typescript
// 1. 異なる店舗での通常シフト重複チェック
const { data: existingShifts } = await supabase
  .from('shifts')
  .select('id, store_id, stores(id, name)')
  .eq('user_id', user_id)
  .eq('date', date)
  .neq('store_id', store_id);

if (existingShifts && existingShifts.length > 0) {
  // エラー返却
}

// 2. 異なる店舗での固定シフト重複チェック
const dateObj = new Date(date);
const dayOfWeek = dateObj.getDay();
const { data: existingFixedShifts } = await supabase
  .from('fixed_shifts')
  .select('id, store_id, stores(id, name)')
  .eq('user_id', user_id)
  .eq('day_of_week', dayOfWeek)
  .eq('time_slot_id', time_slot_id)
  .eq('is_active', true)
  .neq('store_id', store_id);

if (existingFixedShifts && existingFixedShifts.length > 0) {
  // エラー返却
}
```

