# 今週の勤務時間表示の調査結果

## 1. ダッシュボード（`app/staff-dashboard/page.tsx`）のフロー

### データ取得フロー
1. **API呼び出し**: `/api/shifts?user_id={userId}&date_from={日曜日}&date_to={土曜日}&current_user_id={userId}`
2. **使用テーブル**: `shifts`テーブルのみ
3. **取得データ**: 
   - `shifts`テーブルのレコード
   - リレーション: `time_slots(id, name, start_time, end_time)`のみ
   - **注意**: `shift_patterns`は取得されていない
   - **注意**: 固定シフト（`fixed_shifts`）は取得されていない

### 週の定義
- **開始日**: 日曜日（`getDay() === 0`の場合、今日から-0日）
- **終了日**: 土曜日（日曜日から+6日）
- **計算方法**: ログイン日が含まれる週を計算

### 計算ロジック
1. `weeklyShifts`から今週のシフトをフィルタリング（日付文字列で比較）
2. 各シフトの時間を計算：
   - 優先順位: `custom_start_time/custom_end_time` → `shift_patterns` → `time_slots`
   - **問題**: `shift_patterns`はAPIレスポンスに含まれていないため、常に`time_slots`が使用される
   - 休憩時間: デフォルト30分（`shift_patterns.break_time`は参照できない）
   - **問題**: `time_slots.break_minutes`が存在するが使用されていない

### 問題点
1. ❌ 固定シフトが含まれていない（マイシフトでは固定シフトも含まれる）
2. ❌ `shift_patterns`を参照しているが、APIレスポンスに含まれていない
3. ❌ `time_slots.break_minutes`を使用していない（データベースには存在する）

---

## 2. マイシフト（`app/my-shift/page.tsx`）のフロー

### データ取得フロー
1. **API呼び出し**: 
   - `/api/shifts?user_id={userId}&date_from={選択日}&date_to={選択日+6日}`
   - `/api/fixed-shifts?user_id={userId}&is_active=true`
2. **使用テーブル**: 
   - `shifts`テーブル
   - `fixed_shifts`テーブル
3. **取得データ**: 
   - `shifts`テーブルのレコード（リレーション: `time_slots`のみ）
   - `fixed_shifts`テーブルのレコード（リレーション: `time_slots`のみ）
   - **注意**: `shift_patterns`は取得されていないが、コード内で参照している

### 週の定義
- **開始日**: カレンダーで選択した日
- **終了日**: 選択した日から+6日（7日間）
- **計算方法**: 選択した日を含む7日間

### 固定シフトの処理
1. 選択週の各日（7日間）をループ
2. その日に通常シフトが存在しない場合、固定シフトから仮想シフトを生成
3. 固定シフトは`status: 'confirmed'`として扱われる

### 計算ロジック
1. `weekDates`（選択日から7日間）をループ
2. 各日のシフトを取得（通常シフト + 固定シフトから生成された仮想シフト）
3. 各シフトの時間を計算：
   - 優先順位: `custom_start_time/custom_end_time` → `shift_patterns` → `time_slots`
   - **問題**: `shift_patterns`はAPIレスポンスに含まれていないため、常に`time_slots`が使用される
   - 休憩時間: デフォルト30分（`shift_patterns.break_time`は参照できない）
   - **問題**: `time_slots.break_minutes`が存在するが使用されていない

### 問題点
1. ❌ `shift_patterns`を参照しているが、APIレスポンスに含まれていない
2. ❌ `time_slots.break_minutes`を使用していない（データベースには存在する）

---

## 3. APIレスポンスの構造

### `/api/shifts`のレスポンス構造
```typescript
{
  data: [
    {
      id: string,
      date: string,
      user_id: string,
      store_id: string,
      time_slot_id: string,
      status: 'draft' | 'confirmed' | 'completed',
      custom_start_time?: string | null,
      custom_end_time?: string | null,
      time_slots?: {
        id: string,
        name: string,
        start_time: string,
        end_time: string
        // break_minutesは含まれていない（APIのselectクエリに含まれていない）
      },
      // shift_patternsは含まれていない
    }
  ]
}
```

### `/api/fixed-shifts`のレスポンス構造
```typescript
{
  data: [
    {
      id: string,
      user_id: string,
      store_id: string,
      day_of_week: number,
      time_slot_id: string,
      is_active: boolean,
      time_slots?: {
        id: string,
        name: string,
        start_time: string,
        end_time: string
        // break_minutesは含まれていない（APIのselectクエリに含まれていない）
      }
    }
  ]
}
```

---

## 4. データベーススキーマ

### `shifts`テーブル
- `id`, `user_id`, `store_id`, `date`
- `time_slot_id` (新カラム)
- `pattern_id` (旧カラム、段階的削除予定)
- `status`: 'draft' | 'confirmed' | 'completed'
- `custom_start_time`, `custom_end_time`
- リレーション: `time_slots`, `users`, `stores`

### `time_slots`テーブル
- `id`, `store_id`, `name`
- `start_time`, `end_time` (HH:MM形式)
- **`break_minutes`**: 休憩時間（分単位）← **重要: これが使用されていない**
- `hourly_wage`, `color`

### `fixed_shifts`テーブル
- `id`, `user_id`, `store_id`
- `day_of_week`: 0=日曜日, 1=月曜日, ..., 6=土曜日
- `time_slot_id`
- `is_active`
- リレーション: `time_slots`, `users`, `stores`

### `shift_patterns`テーブル
- `id`, `name`
- `start_time`, `end_time`
- `break_time`: 休憩時間（分単位）
- `color`
- **注意**: 現在のAPIでは`shift_patterns`は取得されていない

---

## 5. 主な問題点のまとめ

### 問題1: 固定シフトがダッシュボードに含まれていない
- **ダッシュボード**: 固定シフトを取得していない
- **マイシフト**: 固定シフトを取得し、仮想シフトとして生成している
- **影響**: ダッシュボードの勤務時間が固定シフトを含まないため、実際より少なく表示される

### 問題2: `time_slots.break_minutes`が使用されていない
- **データベース**: `time_slots`テーブルに`break_minutes`カラムが存在
- **API**: `/api/shifts`のselectクエリに`break_minutes`が含まれていない
- **計算**: デフォルト30分を使用している
- **影響**: 実際の休憩時間と異なる可能性がある

### 問題3: `shift_patterns`を参照しているが取得されていない
- **コード**: `shift_patterns.break_time`を参照している
- **API**: `shift_patterns`は取得されていない
- **影響**: 常に`time_slots`が使用され、`shift_patterns`の休憩時間は使用されない

### 問題4: 週の定義が異なる
- **ダッシュボード**: 日曜日始まり、土曜日終わり
- **マイシフト**: 選択した日から7日間
- **影響**: 同じ週でも表示される期間が異なる可能性がある

---

## 6. 推奨される修正方針

1. **APIの修正**: `/api/shifts`のselectクエリに`time_slots.break_minutes`を追加
2. **ダッシュボードの修正**: 固定シフトも取得し、マイシフトと同じ方法で仮想シフトを生成
3. **計算ロジックの修正**: `time_slots.break_minutes`を使用するように変更
4. **`shift_patterns`の扱い**: 現在使用されていないため、コードから削除するか、APIで取得するように修正

